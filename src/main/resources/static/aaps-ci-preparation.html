<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AAPS-CI Auth + Keystore</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/node-forge@1.3.1/dist/forge.min.js"></script>
  <script>
    function showToast(message) {
        const toast = document.getElementById('copyToast');
        toast.textContent = message;
        toast.style.display = 'block';
        setTimeout(() => {
            toast.style.display = 'none';
        }, 2000);
    }
    
    function toggleOption(optionNumber) {
        // 關閉所有選項
        document.querySelectorAll('.option').forEach(option => {
            option.classList.remove('active');
        });
        
        // 開啟被點擊的選項
        document.getElementById('option' + optionNumber).classList.add('active');
    }
    
    // 頁面載入時初始化
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        // 保留原始的 code 處理
        if (urlParams.has('code')) {
            const code = urlParams.get('code');
            exchangeCodeForToken(code);
            
            const clientMode = sessionStorage.getItem('clientMode');
            const customClientId = sessionStorage.getItem('customClientId');
            if (clientMode) {
              const radio = document.querySelector(`input[name="clientMode"][value="${clientMode}"]`);
              if (radio) radio.checked = true;

              if (clientMode === 'custom') {
                const input = document.getElementById('customClientId');
                input.value = customClientId;
                input.style.display = 'block';
              }
              sessionStorage.removeItem('clientMode');
              sessionStorage.removeItem('customClientId');
            }
            return;
        }
        toggleOption(1);
        var customClientInput = document.getElementById('customClientId');
        if (customClientInput) customClientInput.style.display = 'none';
    };
  </script>
  <style>
    .flex-row {
      display: flex;
      align-items: center;
      width: 100%;
      gap: 0.5rem;
    }
    .right-button {
      margin-left: auto;
      white-space: nowrap;
    }
    .label-no-margin {
      margin-bottom: 0;
    }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f9f9f9; color: #333; margin: 0; padding: 1rem; }
    .container { max-width: 800px; margin: auto; background: #fff; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative; }
    h2 { color: #1a73e8; display: flex; align-items: center; gap: 0.5rem; }
    input[type=text], textarea { width: 100%; padding: 0.5rem; margin: 0.5rem 0; border: 1px solid #ccc; border-radius: 4px; }
    .styled-input { width: 100%; padding: 0.5rem; margin: 0.5rem 0; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; font-size: 0.9rem; }
    button { padding: 0.5rem 1rem; background: #0077cc; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:active{ background: #005fa3; }
    .btn-green {
      background: #479c5e !important;
      color: #fff !important;
    }
    .btn-green:active {
      background: #176e30 !important;
    }
    .field-group { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .field-group .right-button { margin-left: auto; }
    .button-group { display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem; }
    .full-width-btn { width: 100%; margin-top: 0.5rem; }
    .auth-controls { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; margin: 0.5rem 0; }
    .auth-controls .custom-client { flex-basis: 100%; display: none; }
    @media (min-width: 600px) {
      .auth-controls .custom-client { flex-basis: auto; display: none; }
    }
    .copy-right {
      margin-top: 0.5rem;
      display: flex;
      justify-content: flex-end;
    }

    .toast {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #34a853;
        color: white;
        padding: 12px 24px;
        border-radius: 6px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        font-weight: 500;
        display: none;
        z-index: 1000;
    }
    
    /* 新增的步驟樣式 */
    .option {
        margin-bottom: 24px;
        border: 1px solid #dadce0;
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    
    .option.active {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-color: #1a73e8;
    }
    
    .option-header {
        padding: 16px 20px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
        background-color: white;
        transition: background-color 0.2s ease;
        border-bottom: 1px solid transparent;
    }
    
    .option.active .option-header {
        border-bottom-color: #dadce0;
        background-color: #e8f0fe;
    }
    
    .option-header:hover {
        background-color: #f8f9fa;
    }
    
    .option-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease, padding 0.3s ease, opacity 0.5s ease, transform 0.5s ease;
        padding: 0 20px;
        opacity: 0;
        transform: translateY(-10px);
    }
    
    .option.active .option-content {
        max-height: 2000px;
        padding: 24px 20px;
        opacity: 1;
        transform: translateY(0);
    }
    
    /* 移除的內聯樣式 */
    .version-badge {
        position: absolute;
        top: 12px;
        left: 16px;
        background: #e3eafc;
        color: #1a73e8;
        font-size: 0.9rem;
        font-weight: 500;
        padding: 4px 12px;
        border-radius: 6px;
        z-index: 10;
        box-shadow: 0 1px 4px rgba(26,115,232,0.07);
        max-width: calc(100% - 32px);
    }
    
    #langSelector {
        position: absolute;
        top: 12px;
        right: 16px;
        padding: 0.3rem 0.5rem;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-size: 1rem;
    }
    
    .header-container {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        margin-top: 20px;
        gap: 20px;
    }
    
    .logo {
        height: 120px;
    }

    .keystore-input {
        flex: 1 1 auto;
        min-width: 200px;
    }
    
    .main-title {
        font-size: 1.5rem;
        color: #1a73e8;
        margin: 0;
        margin-left: -10px;
    }

    .icon-drive {
        height: 24px;
        vertical-align: middle;
        margin-right: 6px;
    }
    #jksFile{
      margin-top: 10px;
      padding-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="version-badge">v1.1.0</div>
    <select id="langSelector" onchange="switchLanguage(this.value)">
        <option value="en">English</option>
        <option value="zh_TW">繁體中文</option>
    </select>
    <div class="header-container">
      <img src="https://raw.githubusercontent.com/Angus-repo/aaps-ci-preparation/main/src/main/resources/static/images/logo.png" alt="AndroidAPS Logo" class="logo">
      <h1 class="main-title">AAPS-CI 準備</h1>
    </div>
    <hr style="margin: 24px 0; border: none; border-top: 1.5px solid #e0e0e0;">
    <div class="option active" id="option1">
      <div class="option-header" onclick="toggleOption(1)">
        <h2>Option 1: 產生 JKS</h2>
        <i class="fas fa-chevron-down option-icon"></i>
      </div>
      <div class="option-content">
        <button id="generateJksBtn" class="btn-green" onclick="generateJks()">🔐 產生 JKS</button>
        <div class="field-group">
          <div class="flex-row">
            <label for="keystoreSet" class="label-no-margin">KEYSTORE_SET:</label>
            <button class="right-button" onclick="copyToClipboardText('KEYSTORE_SET')">📋 複製</button>
          </div>
          <div class="flex-row">
            <input id="keystoreSet" readonly class="keystore-input styled-input label-no-margin">
            <button class="right-button" onclick="copyToClipboard('keystoreSet')">📋 複製</button>
          </div>
        </div>
      </div>
    </div>

    <div class="option" id="option2">
      <div class="option-header" onclick="toggleOption(2)">
        <h2>Option 2: 上傳現有的 JKS</h2>
        <i class="fas fa-chevron-down option-icon"></i>
      </div>
      <div class="option-content">
        <div class="flex-row">
          <label for="keystoreBase64" class="label-no-margin">KEYSTORE_BASE64:</label>
          <button class="right-button" onclick="copyToClipboardText('KEYSTORE_BASE64')">📋 複製</button>
        </div>
        <input type="file" id="jksFile" accept=".jks" onchange="convertJks()" class="btn-green" style="background: #34a853; color: #fff; padding: 0.5rem 1rem; border-radius: 4px; border: none; cursor: pointer; width: auto;">
        <div class="flex-row">
          <input id="keystoreBase64" readonly class="keystore-input styled-input label-no-margin">
          <button class="right-button" onclick="copyToClipboard('keystoreBase64')">📋 複製</button>
        </div>
        <div class="button-group">
          <div class="flex-row">
            <label for="keystorePassword" class="label-no-margin">KEYSTORE_PASSWORD:</label>
            <button class="right-button" onclick="copyToClipboardText('KEYSTORE_PASSWORD')">📋 複製</button>
          </div>
          <div class="flex-row">
            <label for="keystoreAlias" class="label-no-margin">KEY_ALIAS:</label>
            <button class="right-button" onclick="copyToClipboardText('KEY_ALIAS')">📋 複製</button>
          </div>
          <div class="flex-row">
            <label for="keystoreAlias" class="label-no-margin">KEY_PASSWORD:</label>
            <button class="right-button" onclick="copyToClipboardText('KEY_PASSWORD')">📋 複製</button>
          </div>
        </div>
      </div>
    </div>

    <h2><img src="https://raw.githubusercontent.com/Angus-repo/aaps-ci-preparation/main/src/main/resources/static/images/google-drive.png" class="icon-drive">Google OAuth2 驗證</h2>
    <div class="auth-controls">
      <label><input type="radio" name="clientMode" value="default" checked onchange="toggleClientInput()"> 預設</label>
      <label><input type="radio" name="clientMode" value="custom" onchange="toggleClientInput()"> 自訂</label>
      <button class="btn-green" onclick="startAuth()">🚀 開始授權</button>
      <input type="text" class="custom-client styled-input" id="customClientId" placeholder="Your Google Client ID">
    </div>
    <div class="flex-row">
      <label for="oauth2Base64" class="label-no-margin">GDRIVE_OAUTH2:</label>
      <button class="right-button" onclick="copyToClipboardText('GDRIVE_OAUTH2')">📋 複製</button>
    </div>
    <div class="flex-row">
      <input id="oauth2Base64" readonly class="keystore-input styled-input label-no-margin">
      <button class="right-button" onclick="copyToClipboard('oauth2Base64')">📋 複製</button>
    </div>
  </div>

  <script>
    function generateJks() {
  const btn = document.getElementById('generateJksBtn');
  const originalText = btn.innerHTML;
  btn.innerHTML = '🔄 產生中...';
  btn.disabled = true;

  const forge = window.forge;
  forge.pki.rsa.generateKeyPair({ bits: 2048, workers: -1 }, function (err, keys) {
    const cert = forge.pki.createCertificate();
    cert.publicKey = keys.publicKey;
    cert.serialNumber = '01';
    cert.validity.notBefore = new Date();
    cert.validity.notAfter = new Date();
    cert.validity.notAfter.setFullYear(cert.validity.notBefore.getFullYear() + 20);
    const attrs = [{ name: 'commonName', value: 'aaps.app' }];
    cert.setSubject(attrs);
    cert.setIssuer(attrs);
    cert.sign(keys.privateKey, forge.md.sha256.create());

    // 產生10位英數字元的亂數密碼
    const generateRandomPassword = () => {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      for (let i = 0; i < 10; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    };
    
    const password = generateRandomPassword();
    const alias = 'key0';
    const p12Asn1 = forge.pkcs12.toPkcs12Asn1(keys.privateKey, [cert], password, { algorithm: '3des' });
    const p12Der = forge.asn1.toDer(p12Asn1).getBytes();
    const base64 = forge.util.encode64(p12Der);

    const keystoreSet = btoa(`${base64}|${password}|${alias}|${password}`);
    document.getElementById('keystoreSet').value = keystoreSet;

    // 還原按鈕
    btn.innerHTML = originalText;
    btn.disabled = false;
  });
}

    function convertJks() {
      const fileInput = document.getElementById('jksFile');
      const reader = new FileReader();
      if (!fileInput.files.length) return;
      reader.onload = function () {
        const binary = new Uint8Array(reader.result);
        const base64 = forge.util.encode64(forge.util.binary.raw.encode(binary));
        document.getElementById('keystoreBase64').value = base64;
      };
      reader.readAsArrayBuffer(fileInput.files[0]);
    }

    function copyToClipboard(id) {
      const el = document.getElementById(id);
    //   el.select();
    //   el.setSelectionRange(0, 99999);
    //   document.execCommand("copy");
      navigator.clipboard.writeText(el.value);
      showToast("已複製到剪貼簿");
    }

    function copyToClipboardText(text) {
      navigator.clipboard.writeText(text);
      showToast("已複製到剪貼簿");
    }

    const defaultClientId = "705061051276-5ssikkg2ag39l7hj9t63saq549n3s2n5.apps.googleusercontent.com";
    const redirectUri = "http://127.0.0.1:" + window.location.port + window.location.pathname;

    function toggleClientInput() {
      const input = document.getElementById('customClientId');
      const isCustom = document.querySelector('input[name="clientMode"]:checked').value === 'custom';
      input.style.display = isCustom ? 'block' : 'none';
    }

    async function startAuth() {
      let clientId = defaultClientId;
      const clientMode = document.querySelector('input[name="clientMode"]:checked').value;
      if (document.querySelector('input[name="clientMode"]:checked').value === 'custom') {
        clientId = document.getElementById('customClientId').value;
        sessionStorage.setItem('clientMode', clientMode);
        sessionStorage.setItem('customClientId', clientId);
      }
      const codeVerifier = [...crypto.getRandomValues(new Uint8Array(32))].map(b => ('0' + b.toString(16)).slice(-2)).join('');
      const encoder = new TextEncoder();
      const data = encoder.encode(codeVerifier);
      const digest = await crypto.subtle.digest('SHA-256', data);
      const codeChallenge = btoa(String.fromCharCode(...new Uint8Array(digest))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');

      sessionStorage.setItem("pkce_code_verifier", codeVerifier);
      const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${encodeURIComponent(clientId)}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=code&scope=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fdrive.file&access_type=offline&code_challenge_method=S256&code_challenge=${codeChallenge}`;
      window.location.href = authUrl;
    }

    async function exchangeCodeForToken(code) {
      const codeVerifier = sessionStorage.getItem("pkce_code_verifier");
      const clientId = document.querySelector('input[name="clientMode"]:checked').value === 'custom' ? document.getElementById('customClientId').value : defaultClientId;
      const res = await fetch('https://oauth2.googleapis.com/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          client_id: clientId,
          code: code,
          code_verifier: codeVerifier,
          grant_type: 'authorization_code',
          redirect_uri: redirectUri
        }).toString()
      });
      const data = await res.json();
      if (data.refresh_token) {
        // document.getElementById('refreshToken').value = data.refresh_token;
        document.getElementById('oauth2Base64').value = btoa(clientId + '|' + data.refresh_token);
      }
    }


  </script>
  <div class="toast toast-success" id="copyToast">已複製到剪貼簿</div>
</body>
</html>
